- name: Generate conflict comparison PDF
        id: generate_pdf
        if: steps.parse_report.outputs.has_conflicts == 'true'
        run: |
          COMPARISONS_FILE="/tmp/wso2_conflict_comparisons_*.json"
          COMPARISONS_FILE_FOUND=$(ls $COMPARISONS_FILE 2>/dev/null | head -1)
          
          if [ -z "$COMPARISONS_FILE_FOUND" ] || [ ! -f "$COMPARISONS_FILE_FOUND" ]; then
            echo "No comparisons file found, skipping PDF generation"
            echo "pdf_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found comparisons file: $COMPARISONS_FILE_FOUND"
          cat "$COMPARISONS_FILE_FOUND"
          
          # Install required packages using python3 -m pip
          python3 -m pip install --user --quiet reportlab
          
          # Create PDF generation script
          cat > /tmp/generate_diff_pdf.py << 'PYTHON_SCRIPT'
          #!/usr/bin/env python3
          import json
          import sys
          import difflib
          from datetime import datetime
          from reportlab.lib import colors
          from reportlab.lib.pagesizes import A4, landscape
          from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
          from reportlab.lib.units import inch, mm
          from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, PageBreak
          from reportlab.lib.enums import TA_LEFT, TA_CENTER

          def create_diff_pdf(comparisons_file, output_file, environment, product, current_level, latest_level):
              # Load comparisons
              with open(comparisons_file, 'r') as f:
                  comparisons = json.load(f)
              
              if not comparisons:
                  print("No comparisons to process")
                  return False
              
              # Create PDF
              doc = SimpleDocTemplate(
                  output_file,
                  pagesize=landscape(A4),
                  rightMargin=20*mm,
                  leftMargin=20*mm,
                  topMargin=20*mm,
                  bottomMargin=20*mm
              )
              
              styles = getSampleStyleSheet()
              
              # Custom styles
              title_style = ParagraphStyle(
                  'CustomTitle',
                  parent=styles['Heading1'],
                  fontSize=24,
                  spaceAfter=30,
                  alignment=TA_CENTER,
                  textColor=colors.HexColor('#1a1a2e')
              )
              
              subtitle_style = ParagraphStyle(
                  'CustomSubtitle',
                  parent=styles['Normal'],
                  fontSize=12,
                  spaceAfter=20,
                  alignment=TA_CENTER,
                  textColor=colors.HexColor('#4a4a4a')
              )
              
              heading_style = ParagraphStyle(
                  'FileHeading',
                  parent=styles['Heading2'],
                  fontSize=14,
                  spaceBefore=20,
                  spaceAfter=10,
                  textColor=colors.HexColor('#2d3436'),
                  backColor=colors.HexColor('#dfe6e9'),
                  borderPadding=5
              )
              
              code_style = ParagraphStyle(
                  'CodeStyle',
                  parent=styles['Code'],
                  fontSize=7,
                  leading=9,
                  fontName='Courier',
                  leftIndent=10,
                  rightIndent=10
              )
              
              added_style = ParagraphStyle(
                  'AddedLine',
                  parent=code_style,
                  backColor=colors.HexColor('#d4edda'),
                  textColor=colors.HexColor('#155724')
              )
              
              removed_style = ParagraphStyle(
                  'RemovedLine',
                  parent=code_style,
                  backColor=colors.HexColor('#f8d7da'),
                  textColor=colors.HexColor('#721c24')
              )
              
              context_style = ParagraphStyle(
                  'ContextLine',
                  parent=code_style,
                  textColor=colors.HexColor('#6c757d')
              )
              
              elements = []
              
              # Title page
              elements.append(Spacer(1, 50))
              elements.append(Paragraph("WSO2 Update Conflict Report", title_style))
              elements.append(Spacer(1, 20))
              
              # Report info table
              report_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              info_data = [
                  ["Environment:", environment],
                  ["Product:", product],
                  ["Current Level:", f"v{current_level}"],
                  ["Target Level:", f"v{latest_level}"],
                  ["Files with Conflicts:", str(len(comparisons))],
                  ["Report Generated:", report_time]
              ]
              
              info_table = Table(info_data, colWidths=[150, 300])
              info_table.setStyle(TableStyle([
                  ('FONT', (0, 0), (0, -1), 'Helvetica-Bold'),
                  ('FONT', (1, 0), (1, -1), 'Helvetica'),
                  ('FONTSIZE', (0, 0), (-1, -1), 11),
                  ('BOTTOMPADDING', (0, 0), (-1, -1), 8),
                  ('TOPPADDING', (0, 0), (-1, -1), 8),
                  ('ALIGN', (0, 0), (0, -1), 'RIGHT'),
                  ('ALIGN', (1, 0), (1, -1), 'LEFT'),
                  ('TEXTCOLOR', (0, 0), (0, -1), colors.HexColor('#2d3436')),
                  ('TEXTCOLOR', (1, 0), (1, -1), colors.HexColor('#636e72')),
              ]))
              elements.append(info_table)
              
              elements.append(Spacer(1, 30))
              elements.append(Paragraph(
                  "This report contains a diff comparison between the original files (your current customizations) "
                  "and the new files (from WSO2 updates). Lines marked in <font color='green'>green</font> are additions, "
                  "lines marked in <font color='red'>red</font> are removals.",
                  subtitle_style
              ))
              
              elements.append(PageBreak())
              
              # Process each file comparison
              for idx, comp in enumerate(comparisons, 1):
                  filename = comp.get('filename', 'Unknown file')
                  original_content = comp.get('original_content', '')
                  new_content = comp.get('new_content', '')
                  
                  # File header
                  elements.append(Paragraph(f"File {idx}: {filename}", heading_style))
                  
                  # Generate unified diff
                  original_lines = original_content.splitlines(keepends=True)
                  new_lines = new_content.splitlines(keepends=True)
                  
                  diff = list(difflib.unified_diff(
                      original_lines,
                      new_lines,
                      fromfile='Original (Current)',
                      tofile='New (Update)',
                      lineterm=''
                  ))
                  
                  if not diff:
                      elements.append(Paragraph("No differences found.", context_style))
                  else:
                      # Build diff table
                      diff_data = []
                      line_num = 0
                      
                      for line in diff[:500]:  # Limit to 500 lines per file
                          line_num += 1
                          line_clean = line.rstrip('\n\r')
                          
                          # Escape special characters for PDF
                          line_escaped = (line_clean
                              .replace('&', '&amp;')
                              .replace('<', '&lt;')
                              .replace('>', '&gt;'))
                          
                          if line.startswith('+++') or line.startswith('---'):
                              diff_data.append([str(line_num), Paragraph(f"<b>{line_escaped}</b>", context_style)])
                          elif line.startswith('@@'):
                              diff_data.append([str(line_num), Paragraph(f"<font color='blue'>{line_escaped}</font>", context_style)])
                          elif line.startswith('+'):
                              diff_data.append([str(line_num), Paragraph(line_escaped, added_style)])
                          elif line.startswith('-'):
                              diff_data.append([str(line_num), Paragraph(line_escaped, removed_style)])
                          else:
                              diff_data.append([str(line_num), Paragraph(line_escaped, context_style)])
                      
                      if len(diff) > 500:
                          diff_data.append(['...', Paragraph(f"<i>Truncated: {len(diff) - 500} more lines</i>", context_style)])
                      
                      if diff_data:
                          diff_table = Table(diff_data, colWidths=[40, 700])
                          diff_table.setStyle(TableStyle([
                              ('FONT', (0, 0), (-1, -1), 'Courier', 7),
                              ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                              ('ALIGN', (0, 0), (0, -1), 'RIGHT'),
                              ('TEXTCOLOR', (0, 0), (0, -1), colors.HexColor('#adb5bd')),
                              ('LEFTPADDING', (0, 0), (-1, -1), 3),
                              ('RIGHTPADDING', (0, 0), (-1, -1), 3),
                              ('TOPPADDING', (0, 0), (-1, -1), 1),
                              ('BOTTOMPADDING', (0, 0), (-1, -1), 1),
                          ]))
                          elements.append(diff_table)
                  
                  if idx < len(comparisons):
                      elements.append(PageBreak())
              
              # Build PDF
              doc.build(elements)
              print(f"PDF generated: {output_file}")
              return True

          if __name__ == "__main__":
              comparisons_file = sys.argv[1]
              output_file = sys.argv[2]
              environment = sys.argv[3] if len(sys.argv) > 3 else "Unknown"
              product = sys.argv[4] if len(sys.argv) > 4 else "WSO2"
              current_level = sys.argv[5] if len(sys.argv) > 5 else "Unknown"
              latest_level = sys.argv[6] if len(sys.argv) > 6 else "Unknown"
              
              success = create_diff_pdf(comparisons_file, output_file, environment, product, current_level, latest_level)
              sys.exit(0 if success else 1)
          PYTHON_SCRIPT
          
          chmod +x /tmp/generate_diff_pdf.py
          
          # Generate PDF
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          PRODUCT="${{ steps.parse_report.outputs.product }} ${{ steps.parse_report.outputs.product_version }}"
          CURRENT_LEVEL="${{ steps.parse_report.outputs.current_level }}"
          LATEST_LEVEL="${{ steps.parse_report.outputs.latest_level }}"
          
          PDF_FILE="/tmp/wso2_conflict_report_${ENVIRONMENT}_$(date +%Y%m%d_%H%M%S).pdf"
          
          python3 /tmp/generate_diff_pdf.py "$COMPARISONS_FILE_FOUND" "$PDF_FILE" "$ENVIRONMENT" "$PRODUCT" "$CURRENT_LEVEL" "$LATEST_LEVEL"
          
          if [ -f "$PDF_FILE" ]; then
            echo "PDF generated successfully: $PDF_FILE"
            echo "pdf_path=$PDF_FILE" >> $GITHUB_OUTPUT
            echo "pdf_generated=true" >> $GITHUB_OUTPUT
            echo "pdf_name=$(basename $PDF_FILE)" >> $GITHUB_OUTPUT
          else
            echo "Failed to generate PDF"
            echo "pdf_generated=false" >> $GITHUB_OUTPUT
          fi
