- name: Send Teams notification
        run: |
          if [ -z "$TEAMS_WEBHOOK_URL" ]; then
            echo "Teams webhook not configured, skipping"
            exit 0
          fi
          
          # Get values from previous job
          CURRENT_LEVEL="${{ needs.check-updates.outputs.current_level }}"
          LATEST_LEVEL="${{ needs.check-updates.outputs.latest_level }}"
          UPDATES_AVAILABLE="${{ needs.check-updates.outputs.updates_available }}"
          UPDATES_COUNT="${{ needs.check-updates.outputs.updates_count }}"
          STATUS="${{ needs.check-updates.outputs.status }}"
          HOST="${{ needs.check-updates.outputs.host }}"
          PRODUCT="${{ needs.check-updates.outputs.product }}"
          PRODUCT_VERSION="${{ needs.check-updates.outputs.product_version }}"
          HAS_CONFLICTS="${{ needs.check-updates.outputs.has_conflicts }}"
          CONFLICT_COUNT="${{ needs.check-updates.outputs.conflict_count }}"
          CONFLICT_FILES="${{ needs.check-updates.outputs.conflict_files }}"
          DRY_RUN_ID="${{ needs.check-updates.outputs.dry_run_id }}"
          DRY_RUN_PATH="${{ needs.check-updates.outputs.dry_run_path }}"
          
          # Determine theme color and title based on status
          if [ "$HAS_CONFLICTS" = "true" ]; then
            TITLE="üö® WSO2 IAM Update Conflicts Detected"
            THEME_COLOR="DC3545"
          elif [ "$UPDATES_AVAILABLE" = "true" ]; then
            TITLE="‚ö†Ô∏è WSO2 IAM Patch Updates Available"
            THEME_COLOR="FFA500"
          else
            TITLE="‚úÖ WSO2 IAM Update Check Complete"
            THEME_COLOR="28A745"
          fi
          
          # Determine environment
          if [ "${{ github.event_name }}" = "schedule" ]; then
            ENVIRONMENT="${{ env.DEFAULT_ENVIRONMENT }}"
            TRIGGER="Scheduled (Monthly)"
          else
            ENVIRONMENT="${{ inputs.environment }}"
            TRIGGER="Manual"
          fi
          
          CHECK_TIME=$(TZ='Asia/Colombo' date +"%Y-%m-%d %H:%M:%S IST")
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Build base facts array
          FACTS=$(jq -n \
            --arg env "$ENVIRONMENT" \
            --arg product "$PRODUCT $PRODUCT_VERSION" \
            --arg current "v$CURRENT_LEVEL" \
            --arg latest "v$LATEST_LEVEL" \
            --arg count "$UPDATES_COUNT update(s)" \
            --arg trigger "$TRIGGER (${{ github.actor }})" \
            --arg time "$CHECK_TIME" \
            '[
              { "name": "üåç Environment", "value": ("**" + $env + "**") },
              { "name": "üñ•Ô∏è Host", "value": "IAM" },
              { "name": "üì¶ Product", "value": $product },
              { "name": "üìç Current Level", "value": $current },
              { "name": "üéØ Latest Level", "value": $latest },
              { "name": "üîÑ Updates Count", "value": $count },
              { "name": "üë§ Triggered By", "value": $trigger },
              { "name": "üïê Check Time", "value": $time }
            ]')
          
          # Add conflict fact if needed
          if [ "$HAS_CONFLICTS" = "true" ]; then
            FACTS=$(echo "$FACTS" | jq --arg cc "$CONFLICT_COUNT" '. + [{ "name": "‚ö†Ô∏è Conflicts", "value": ("**" + $cc + " file(s) with conflicts**") }]')
          fi
          
          # Add dry run ID fact if conflicts exist and we have the ID
          if [ "$HAS_CONFLICTS" = "true" ] && [ -n "$DRY_RUN_ID" ]; then
            FACTS=$(echo "$FACTS" | jq --arg drid "$DRY_RUN_ID" '. + [{ "name": "üîñ Dry Run ID", "value": $drid }]')
          fi
          
          # Build main section
          MAIN_SECTION=$(jq -n \
            --arg title "$TITLE" \
            --argjson facts "$FACTS" \
            '{
              "activityTitle": $title,
              "facts": $facts,
              "markdown": true
            }')
          
          # Build sections array starting with main section
          SECTIONS=$(echo "[$MAIN_SECTION]")
          
          # Add conflict files section if needed
          if [ "$HAS_CONFLICTS" = "true" ] && [ -n "$CONFLICT_FILES" ] && [ "$CONFLICT_FILES" != "None" ]; then
            # Build conflict files as facts array for better formatting
            CONFLICT_FACTS=$(echo "$CONFLICT_FILES" | tr ',' '\n' | sed 's/^ *//' | jq -R -s -c 'split("\n") | map(select(length > 0)) | to_entries | map({ "name": ("File " + ((.key + 1) | tostring)), "value": .value })')
            
            CONFLICT_SECTION=$(jq -n \
              --argjson facts "$CONFLICT_FACTS" \
              '{
                "activityTitle": "üìÅ Conflict Files (Manual Resolution Required)",
                "facts": $facts,
                "markdown": true
              }')
            
            SECTIONS=$(echo "$SECTIONS" | jq --argjson cs "$CONFLICT_SECTION" '. + [$cs]')
          fi
          
          # Build final payload
          JSON_PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg theme "$THEME_COLOR" \
            --arg url "$WORKFLOW_URL" \
            --argjson sections "$SECTIONS" \
            '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": $theme,
              "summary": $title,
              "sections": $sections,
              "potentialAction": [
                {
                  "@type": "OpenUri",
                  "name": "View Workflow Run",
                  "targets": [{ "os": "default", "uri": $url }]
                }
              ]
            }')
          
          echo "JSON Payload:"
          echo "$JSON_PAYLOAD" | jq .
          
          echo "Sending notification to Teams..."
          
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" \
            --proxy "${HTTPS_PROXY:-}" \
            --connect-timeout 30 \
            --max-time 60 \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "$TEAMS_WEBHOOK_URL")
          
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -1)
          RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
          
          echo "Response code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::warning::Teams notification failed with code $HTTP_CODE"
          else
            echo "Teams notification sent successfully"
          fi
