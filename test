- name: Generate conflict comparison report
        id: generate_report
        if: steps.parse_report.outputs.has_conflicts == 'true'
        run: |
          COMPARISONS_FILE="/tmp/wso2_conflict_comparisons_*.json"
          COMPARISONS_FILE_FOUND=$(ls $COMPARISONS_FILE 2>/dev/null | head -1)
          
          if [ -z "$COMPARISONS_FILE_FOUND" ] || [ ! -f "$COMPARISONS_FILE_FOUND" ]; then
            echo "No comparisons file found, skipping report generation"
            echo "report_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found comparisons file: $COMPARISONS_FILE_FOUND"
          
          # Create HTML report generation script (no external dependencies)
          cat > /tmp/generate_diff_report.py << 'PYTHON_SCRIPT'
          #!/usr/bin/env python3
          import json
          import sys
          import difflib
          from datetime import datetime
          import html

          def create_diff_html(comparisons_file, output_file, environment, product, current_level, latest_level):
              with open(comparisons_file, 'r') as f:
                  comparisons = json.load(f)
              
              if not comparisons:
                  print("No comparisons to process")
                  return False
              
              report_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              
              html_content = f'''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>WSO2 Update Conflict Report</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }}
                  .container {{ max-width: 1400px; margin: 0 auto; padding: 20px; }}
                  .header {{ background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 40px; border-radius: 10px; margin-bottom: 30px; text-align: center; }}
                  .header h1 {{ font-size: 2.5em; margin-bottom: 10px; }}
                  .info-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 30px 0; }}
                  .info-card {{ background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                  .info-card .label {{ font-size: 0.85em; color: #666; text-transform: uppercase; }}
                  .info-card .value {{ font-size: 1.4em; font-weight: 600; color: #1a1a2e; margin-top: 5px; }}
                  .file-section {{ background: white; border-radius: 10px; margin-bottom: 30px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }}
                  .file-header {{ background: #e9ecef; padding: 20px; border-bottom: 1px solid #dee2e6; }}
                  .file-header h2 {{ font-size: 1.1em; color: #495057; word-break: break-all; }}
                  .diff-table {{ width: 100%; border-collapse: collapse; font-family: monospace; font-size: 12px; }}
                  .diff-table td {{ padding: 2px 10px; white-space: pre-wrap; word-break: break-all; }}
                  .diff-table .line-num {{ width: 50px; text-align: right; color: #adb5bd; background: #f8f9fa; }}
                  .diff-table tr.added {{ background: #d4edda; }}
                  .diff-table tr.removed {{ background: #f8d7da; }}
                  .diff-table tr.header {{ background: #cce5ff; }}
                  .diff-table tr.range {{ background: #e2e3e5; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header"><h1>WSO2 Update Conflict Report</h1></div>
                  <div class="info-grid">
                      <div class="info-card"><div class="label">Environment</div><div class="value">{html.escape(environment)}</div></div>
                      <div class="info-card"><div class="label">Product</div><div class="value">{html.escape(product)}</div></div>
                      <div class="info-card"><div class="label">Current Level</div><div class="value">v{html.escape(current_level)}</div></div>
                      <div class="info-card"><div class="label">Target Level</div><div class="value">v{html.escape(latest_level)}</div></div>
                      <div class="info-card"><div class="label">Files with Conflicts</div><div class="value">{len(comparisons)}</div></div>
                      <div class="info-card"><div class="label">Report Generated</div><div class="value">{report_time}</div></div>
                  </div>
          '''
              
              for idx, comp in enumerate(comparisons, 1):
                  filename = comp.get('filename', 'Unknown file')
                  original_content = comp.get('original_content', '')
                  new_content = comp.get('new_content', '')
                  
                  html_content += f'<div class="file-section"><div class="file-header"><h2>File {idx}: {html.escape(filename)}</h2></div><div class="diff-container">'
                  
                  diff = list(difflib.unified_diff(original_content.splitlines(keepends=True), new_content.splitlines(keepends=True), lineterm=''))
                  
                  if not diff:
                      html_content += '<p style="padding:20px">No differences found.</p>'
                  else:
                      html_content += '<table class="diff-table">'
                      for i, line in enumerate(diff[:1000], 1):
                          line_escaped = html.escape(line.rstrip())
                          if line.startswith('+++') or line.startswith('---'):
                              cls = 'header'
                          elif line.startswith('@@'):
                              cls = 'range'
                          elif line.startswith('+'):
                              cls = 'added'
                          elif line.startswith('-'):
                              cls = 'removed'
                          else:
                              cls = ''
                          html_content += f'<tr class="{cls}"><td class="line-num">{i}</td><td>{line_escaped}</td></tr>'
                      html_content += '</table>'
                  html_content += '</div></div>'
              
              html_content += '</div></body></html>'
              
              with open(output_file, 'w') as f:
                  f.write(html_content)
              print(f"Report generated: {output_file}")
              return True

          if __name__ == "__main__":
              success = create_diff_html(sys.argv[1], sys.argv[2], sys.argv[3] if len(sys.argv) > 3 else "Unknown", sys.argv[4] if len(sys.argv) > 4 else "WSO2", sys.argv[5] if len(sys.argv) > 5 else "Unknown", sys.argv[6] if len(sys.argv) > 6 else "Unknown")
              sys.exit(0 if success else 1)
          PYTHON_SCRIPT
          
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          PRODUCT="${{ steps.parse_report.outputs.product }} ${{ steps.parse_report.outputs.product_version }}"
          CURRENT_LEVEL="${{ steps.parse_report.outputs.current_level }}"
          LATEST_LEVEL="${{ steps.parse_report.outputs.latest_level }}"
          
          REPORT_FILE="/tmp/wso2_conflict_report_${ENVIRONMENT}_$(date +%Y%m%d_%H%M%S).html"
          
          python3 /tmp/generate_diff_report.py "$COMPARISONS_FILE_FOUND" "$REPORT_FILE" "$ENVIRONMENT" "$PRODUCT" "$CURRENT_LEVEL" "$LATEST_LEVEL"
          
          if [ -f "$REPORT_FILE" ]; then
            echo "Report generated successfully: $REPORT_FILE"
            echo "report_path=$REPORT_FILE" >> $GITHUB_OUTPUT
            echo "report_generated=true" >> $GITHUB_OUTPUT
            echo "report_name=$(basename $REPORT_FILE)" >> $GITHUB_OUTPUT
          else
            echo "Failed to generate report"
            echo "report_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload conflict report artifact
        id: upload_artifact
        if: steps.generate_report.outputs.report_generated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HTTPS_PROXY: 'http://192.168.5.60:8080'
          HTTP_PROXY: 'http://192.168.5.60:8080'
          NODE_TLS_REJECT_UNAUTHORIZED: '0'
        run: |
          REPORT_FILE="${{ steps.generate_report.outputs.report_path }}"
          REPORT_NAME="${{ steps.generate_report.outputs.report_name }}"
          
          if [ ! -f "$REPORT_FILE" ]; then
            echo "Report file not found: $REPORT_FILE"
            echo "uploaded=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Report file: $REPORT_FILE"
          echo "Report name: $REPORT_NAME"
          echo "File size: $(stat -c%s "$REPORT_FILE") bytes"
          
          # Save to a persistent location on the runner
          REPORTS_DIR="/opt/wso2-reports/${{ github.run_id }}"
          mkdir -p "$REPORTS_DIR" 2>/dev/null || {
            REPORTS_DIR="/tmp/wso2-reports/${{ github.run_id }}"
            mkdir -p "$REPORTS_DIR"
          }
          
          cp "$REPORT_FILE" "$REPORTS_DIR/"
          echo "Report saved to: $REPORTS_DIR/$REPORT_NAME"
          
          echo "uploaded=true" >> $GITHUB_OUTPUT
          echo "report_name=$REPORT_NAME" >> $GITHUB_OUTPUT
          echo "local_path=$REPORTS_DIR/$REPORT_NAME" >> $GITHUB_OUTPUT
