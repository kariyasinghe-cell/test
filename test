---
- name: WSO2 Update Level Check
  hosts: all
  gather_facts: yes

  vars:
    wso2_update_tool: "{{ wso2_home }}/bin/wso2update_linux"
    update_check_timeout: 120

  tasks:
    - name: Verify WSO2 home exists
      ansible.builtin.stat:
        path: "{{ wso2_home }}"
      register: wso2_home_check

    - name: Fail if WSO2 home does not exist
      ansible.builtin.fail:
        msg: "WSO2 home directory does not exist: {{ wso2_home }}"
      when: not wso2_home_check.stat.exists

    - name: Verify update tool exists
      ansible.builtin.stat:
        path: "{{ wso2_update_tool }}"
      register: update_tool_check

    - name: Fail if update tool does not exist
      ansible.builtin.fail:
        msg: "WSO2 update tool not found: {{ wso2_update_tool }}"
      when: not update_tool_check.stat.exists

    - name: Print Environment Variables
      ansible.builtin.shell:
        cmd: "printenv"
        chdir: "{{ wso2_home }}/bin"

    - name: Get current update state
      ansible.builtin.shell:
        cmd: "./wso2update_linux current-state"
        chdir: "{{ wso2_home }}/bin"
      register: current_state_output
      changed_when: false
      failed_when: false
      timeout: "{{ update_check_timeout }}"
      become: false

    - name: Check available updates
      ansible.builtin.shell:
        cmd: "export http_proxy='{{ http_proxy_url }}' && export https_proxy='{{ https_proxy_url }}' && ./wso2update_linux check -u {{ wso2_update_username }} -p {{ wso2_update_password }}"
        chdir: "{{ wso2_home }}/bin"
      register: check_updates_output
      changed_when: false
      failed_when: false
      timeout: "{{ update_check_timeout }}"
      become: false

    - name: Get update tool version
      ansible.builtin.shell:
        cmd: "./wso2update_linux version"
        chdir: "{{ wso2_home }}/bin"
      register: tool_version_output
      changed_when: false
      failed_when: false
      become: false

    - name: Display raw current state output
      ansible.builtin.debug:
        msg: "{{ current_state_output.stdout_lines | default(['No output']) }}"

    - name: Display raw check output
      ansible.builtin.debug:
        msg: "{{ check_updates_output.stdout_lines | default(['No output']) }}"

    - name: WSO2 updates dry run
      ansible.builtin.shell:
        cmd: "export http_proxy='{{ http_proxy_url }}' && export https_proxy='{{ https_proxy_url }}' && ./wso2update_linux -u {{ wso2_update_username }} -p {{ wso2_update_password }} --dry-run --no-backup"
        chdir: "{{ wso2_home }}/bin"
      register: updates_dry_run
      changed_when: false
      failed_when: false
      timeout: "{{ update_check_timeout }}"
      become: false

    - name: Display dry run output
      ansible.builtin.debug:
        msg: "{{ updates_dry_run.stdout_lines | default(['No output']) }}"

    - name: Parse outputs and extract conflicts
      ansible.builtin.shell: |
        CURRENT_LEVEL=$(echo "{{ current_state_output.stdout | default('') }}" | grep -oP 'wso2.*-\d+\.\d+\.\d+\.\K\d+' | head -1)
        [ -z "$CURRENT_LEVEL" ] && CURRENT_LEVEL="Unknown"
        
        LATEST_LEVEL=$(echo "{{ check_updates_output.stdout | default('') }}" | grep -oP "latest update level is '[^']*\.\K\d+(?=')" | head -1)
        [ -z "$LATEST_LEVEL" ] && LATEST_LEVEL="Unknown"
        
        if echo "{{ current_state_output.stdout | default('') }}" | grep -qi "no hotfixes applied"; then
          HOTFIXES="None"
        else
          HOTFIXES=$(echo "{{ current_state_output.stdout | default('') }}" | grep -oP '(?i)hotfix.*:\s*\K.+' | head -1)
          [ -z "$HOTFIXES" ] && HOTFIXES="None"
        fi
        
        UPDATES_COUNT=$(echo "{{ check_updates_output.stdout | default('') }}" | grep -oP '\d+(?=\s+updates applied)' | head -1)
        [ -z "$UPDATES_COUNT" ] && UPDATES_COUNT="0"
        
        if [ "$CURRENT_LEVEL" != "Unknown" ] && [ "$LATEST_LEVEL" != "Unknown" ] && [ "$CURRENT_LEVEL" != "$LATEST_LEVEL" ]; then
          UPDATES_AVAILABLE="true"
        elif echo "{{ check_updates_output.stdout | default('') | lower }}" | grep -qiE "consists of.*updates"; then
          UPDATES_AVAILABLE="true"
        else
          UPDATES_AVAILABLE="false"
        fi
        
        # Parse conflicts and dry-run ID from dry run output
        DRY_RUN_STDOUT="{{ updates_dry_run.stdout | default('') }}"
        DRY_RUN_STDERR="{{ updates_dry_run.stderr | default('') }}"
        HAS_CONFLICTS="false"
        CONFLICTS_JSON="[]"
        DRY_RUN_ID=""
        DRY_RUN_PATH=""
        
        if echo "$DRY_RUN_STDERR" | grep -qi "conflicts encountered"; then
          HAS_CONFLICTS="true"
          
          # Extract dry-run ID from file paths (e.g., wso2is-5.11.0-1769768372)
          DRY_RUN_ID=$(echo "$DRY_RUN_STDOUT" | grep -oP 'dry-run/[^/]+-\K\d{10,}' | head -1)
          
          # Extract full dry-run path
          DRY_RUN_PATH=$(echo "$DRY_RUN_STDOUT" | grep -oP '/[^[:space:]]*dry-run/[^/]+' | head -1)
          
          # Extract file paths between "File modification failed." and "Conflicts are found"
          CONFLICT_FILES=$(echo "$DRY_RUN_STDOUT" | \
            sed -n '/File modification failed/,/Conflicts are found/p' | \
            grep -E '^\/' | \
            sed 's/.*dry-run\/[^/]*\///' | \
            head -20)
          
          if [ -n "$CONFLICT_FILES" ]; then
            CONFLICTS_JSON=$(echo "$CONFLICT_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
        fi
        
        cat << EOF
        {
          "current_level": "$CURRENT_LEVEL",
          "latest_level": "$LATEST_LEVEL",
          "hotfixes": "$HOTFIXES",
          "updates_count": "$UPDATES_COUNT",
          "updates_available": $UPDATES_AVAILABLE,
          "has_conflicts": $HAS_CONFLICTS,
          "conflict_files": $CONFLICTS_JSON,
          "dry_run_id": "$DRY_RUN_ID",
          "dry_run_path": "$DRY_RUN_PATH"
        }
        EOF
      register: parsed_output
      delegate_to: localhost
      become: false
      changed_when: false

    - name: Set parsed facts
      ansible.builtin.set_fact:
        parsed_data: "{{ parsed_output.stdout | from_json }}"

    - name: Set update variables
      ansible.builtin.set_fact:
        current_update_level: "{{ parsed_data.current_level }}"
        latest_available_level: "{{ parsed_data.latest_level }}"
        current_hotfixes: "{{ parsed_data.hotfixes }}"
        available_updates_count: "{{ parsed_data.updates_count }}"
        updates_available: "{{ parsed_data.updates_available }}"
        has_conflicts: "{{ parsed_data.has_conflicts }}"
        conflict_files: "{{ parsed_data.conflict_files }}"
        dry_run_id: "{{ parsed_data.dry_run_id }}"
        dry_run_path: "{{ parsed_data.dry_run_path }}"

    # ==================== CONFLICT COMPARISON TASKS START ====================
    
    - name: Debug has_conflicts and dry_run_path
      ansible.builtin.debug:
        msg: "has_conflicts={{ has_conflicts }}, dry_run_path={{ dry_run_path }}"

    - name: Set conflicts.json path
      ansible.builtin.set_fact:
        conflicts_json_path: "{{ dry_run_path }}/updates/conflicts.json"
      when: has_conflicts | bool

    - name: Check if conflicts.json exists
      ansible.builtin.stat:
        path: "{{ conflicts_json_path }}"
      register: conflicts_json_stat
      when: has_conflicts | bool

    - name: Display conflicts.json check result
      ansible.builtin.debug:
        msg: "Conflicts.json exists: {{ conflicts_json_stat.stat.exists | default(false) }} at {{ conflicts_json_path | default('N/A') }}"
      when: has_conflicts | bool

    - name: Read conflicts.json from remote server
      ansible.builtin.slurp:
        src: "{{ conflicts_json_path }}"
      register: conflicts_json_content
      when: 
        - has_conflicts | bool
        - conflicts_json_stat.stat.exists | default(false)

    - name: Parse conflicts.json
      ansible.builtin.set_fact:
        conflicts_data: "{{ conflicts_json_content.content | b64decode | from_json }}"
      when:
        - has_conflicts | bool
        - conflicts_json_content is defined
        - conflicts_json_content.content is defined

    - name: Display conflicts data
      ansible.builtin.debug:
        msg: "Found {{ conflicts_data | length }} conflict entries"
      when:
        - has_conflicts | bool
        - conflicts_data is defined

    - name: Fetch original file contents
      ansible.builtin.slurp:
        src: "{{ item.original }}"
      register: original_files
      loop: "{{ conflicts_data | default([]) }}"
      loop_control:
        label: "{{ item.original | basename }}"
      when:
        - has_conflicts | bool
        - conflicts_data is defined
        - conflicts_data | length > 0
      failed_when: false

    - name: Fetch new file contents
      ansible.builtin.slurp:
        src: "{{ item.new }}"
      register: new_files
      loop: "{{ conflicts_data | default([]) }}"
      loop_control:
        label: "{{ item.new | basename }}"
      when:
        - has_conflicts | bool
        - conflicts_data is defined
        - conflicts_data | length > 0
      failed_when: false

    - name: Build conflict comparisons data
      ansible.builtin.set_fact:
        conflict_comparisons: "{{ conflict_comparisons | default([]) + [comparison_item] }}"
      vars:
        comparison_item:
          filename: "{{ original_files.results[my_idx].item.original | regex_replace('.*dry-run/[^/]+/', '') | regex_replace('\\.original$', '') }}"
          original_path: "{{ original_files.results[my_idx].item.original }}"
          new_path: "{{ original_files.results[my_idx].item.new }}"
          original_content: "{{ original_files.results[my_idx].content | default('') | b64decode }}"
          new_content: "{{ new_files.results[my_idx].content | default('') | b64decode }}"
      loop: "{{ conflicts_data | default([]) }}"
      loop_control:
        index_var: my_idx
        label: "Building comparison {{ my_idx + 1 }}"
      when:
        - has_conflicts | bool
        - original_files is defined
        - original_files.results is defined
        - new_files is defined
        - new_files.results is defined
        - original_files.results | length > 0

    - name: Display conflict comparisons summary
      ansible.builtin.debug:
        msg: "Built {{ conflict_comparisons | default([]) | length }} conflict comparisons"
      when: has_conflicts | bool

    - name: Save conflict comparisons to JSON file
      ansible.builtin.copy:
        content: "{{ conflict_comparisons | default([]) | to_nice_json }}"
        dest: "/tmp/wso2_conflict_comparisons_{{ inventory_hostname }}.json"
        mode: '0644'
      delegate_to: localhost
      become: false
      when:
        - has_conflicts | bool
        - conflict_comparisons is defined
        - conflict_comparisons | length > 0

    # ==================== CONFLICT COMPARISON TASKS END ====================

    - name: Determine update status
      ansible.builtin.set_fact:
        update_status: >-
          {%- if has_conflicts -%}
            Conflicts Detected
          {%- elif updates_available -%}
            Updates Available
          {%- else -%}
            Up to Date
          {%- endif -%}
        update_status_emoji: >-
          {%- if has_conflicts -%}
            ğŸš¨
          {%- elif updates_available -%}
            âš ï¸
          {%- else -%}
            âœ…
          {%- endif -%}

    - name: Build update report
      ansible.builtin.set_fact:
        update_report:
          host: "{{ inventory_hostname }}"
          ansible_host: "{{ ansible_host }}"
          product: "{{ wso2_product | default('apim') }}"
          product_version: "{{ wso2_version | default('Unknown') }}"
          current_level: "{{ current_update_level }}"
          latest_level: "{{ latest_available_level }}"
          hotfixes_applied: "{{ current_hotfixes }}"
          updates_available: "{{ updates_available }}"
          updates_count: "{{ available_updates_count }}"
          has_conflicts: "{{ has_conflicts }}"
          conflict_files: "{{ conflict_files }}"
          conflict_count: "{{ conflict_files | length }}"
          dry_run_id: "{{ dry_run_id }}"
          dry_run_path: "{{ dry_run_path }}"
          status: "{{ update_status | trim }}"
          status_emoji: "{{ update_status_emoji | trim }}"
          tool_version: "{{ tool_version_output.stdout_lines[0] | default('Unknown') }}"
          check_timestamp: "{{ ansible_date_time.iso8601 }}"

    - name: Display update report
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                       WSO2 UPDATE LEVEL CHECK REPORT
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Host:              {{ update_report.host }}
           Product:           {{ update_report.product }} {{ update_report.product_version }}
           Current Level:     {{ update_report.current_level }}
           Latest Level:      {{ update_report.latest_level }}
           Hotfixes Applied:  {{ update_report.hotfixes_applied }}
           Updates Available: {{ update_report.updates_count }}
           Has Conflicts:     {{ update_report.has_conflicts }}
           Conflict Count:    {{ update_report.conflict_count }}
           Dry Run ID:        {{ update_report.dry_run_id | default('N/A') }}
           Dry Run Path:      {{ update_report.dry_run_path | default('N/A') }}
           Status:            {{ update_report.status_emoji }} {{ update_report.status }}
           Tool Version:      {{ update_report.tool_version }}
           Check Time:        {{ update_report.check_timestamp }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% if update_report.has_conflicts and update_report.conflict_files | length > 0 %}
          
           CONFLICT FILES:
          {% for file in update_report.conflict_files %}
             - {{ file }}
          {% endfor %}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% endif %}

    - name: Save report to JSON file
      ansible.builtin.copy:
        content: "{{ update_report | to_nice_json }}"
        dest: "/tmp/wso2_update_report_{{ inventory_hostname }}.json"
        mode: '0644'
      delegate_to: localhost
      become: false

    - name: Clean WSO2 dry run folder
      ansible.builtin.shell:
        cmd: "rm -rf /wso2_bkp/.wso2-updates/dry-run/*"
        chdir: "{{ wso2_home }}/bin"
      register: clean_wso2_dry_run_folder
      changed_when: false
      failed_when: false
      timeout: "{{ update_check_timeout }}"
      become: false
