- name: Upload conflict report artifact
        id: upload_artifact
        if: steps.generate_pdf.outputs.report_generated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HTTP_PROXY: 'http://your-proxy-url:port'
          HTTPS_PROXY: 'http://your-proxy-url:port'
        run: |
          REPORT_FILE="${{ steps.generate_pdf.outputs.report_path }}"
          REPORT_NAME=$(basename "$REPORT_FILE")
          ARTIFACT_NAME="wso2-conflict-report"
          
          if [ ! -f "$REPORT_FILE" ]; then
            echo "Report file not found: $REPORT_FILE"
            echo "uploaded=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Uploading artifact: $REPORT_NAME"
          echo "File size: $(stat -c%s "$REPORT_FILE") bytes"
          
          # Compress the file
          ARCHIVE_FILE="/tmp/${ARTIFACT_NAME}.zip"
          zip -j "$ARCHIVE_FILE" "$REPORT_FILE"
          
          # Get the Actions runtime URL and token from environment
          # These are automatically set by GitHub Actions
          ACTIONS_RUNTIME_URL="${ACTIONS_RUNTIME_URL:-}"
          ACTIONS_RUNTIME_TOKEN="${ACTIONS_RUNTIME_TOKEN:-}"
          
          if [ -n "$ACTIONS_RUNTIME_URL" ] && [ -n "$ACTIONS_RUNTIME_TOKEN" ]; then
            echo "Using Actions Runtime API..."
            
            # Create artifact container
            CREATE_URL="${ACTIONS_RUNTIME_URL}_apis/pipelines/workflows/${{ github.run_id }}/artifacts?api-version=6.0-preview"
            
            CREATE_RESPONSE=$(curl -s -X POST \
              --proxy "${HTTPS_PROXY}" \
              -H "Authorization: Bearer $ACTIONS_RUNTIME_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json;api-version=6.0-preview" \
              "$CREATE_URL" \
              -d "{\"type\":\"actions_storage\",\"name\":\"$ARTIFACT_NAME\"}")
            
            echo "Create response: $CREATE_RESPONSE"
            
            UPLOAD_URL=$(echo "$CREATE_RESPONSE" | jq -r '.fileContainerResourceUrl')
            
            if [ -n "$UPLOAD_URL" ] && [ "$UPLOAD_URL" != "null" ]; then
              # Upload the file
              UPLOAD_RESPONSE=$(curl -s -X PUT \
                --proxy "${HTTPS_PROXY}" \
                -H "Authorization: Bearer $ACTIONS_RUNTIME_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                -H "Content-Range: bytes 0-$(($(stat -c%s "$ARCHIVE_FILE") - 1))/*" \
                --data-binary @"$ARCHIVE_FILE" \
                "${UPLOAD_URL}?itemPath=${ARTIFACT_NAME}/${REPORT_NAME}")
              
              echo "Upload response: $UPLOAD_RESPONSE"
              
              # Finalize the artifact
              FINALIZE_URL="${ACTIONS_RUNTIME_URL}_apis/pipelines/workflows/${{ github.run_id }}/artifacts?api-version=6.0-preview"
              
              FINALIZE_RESPONSE=$(curl -s -X PATCH \
                --proxy "${HTTPS_PROXY}" \
                -H "Authorization: Bearer $ACTIONS_RUNTIME_TOKEN" \
                -H "Content-Type: application/json" \
                "$FINALIZE_URL" \
                -d "{\"name\":\"$ARTIFACT_NAME\",\"size\":$(stat -c%s "$ARCHIVE_FILE")}")
              
              echo "Finalize response: $FINALIZE_RESPONSE"
              echo "uploaded=true" >> $GITHUB_OUTPUT
            else
              echo "Failed to get upload URL"
              echo "uploaded=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Actions Runtime API not available, saving locally..."
            
            # Save to a persistent location
            REPORTS_DIR="/opt/wso2-reports"
            mkdir -p "$REPORTS_DIR" 2>/dev/null || {
              REPORTS_DIR="/tmp/wso2-reports"
              mkdir -p "$REPORTS_DIR"
            }
            
            cp "$REPORT_FILE" "$REPORTS_DIR/"
            echo "Report saved to: $REPORTS_DIR/$REPORT_NAME"
            echo "uploaded=false" >> $GITHUB_OUTPUT
            echo "local_path=$REPORTS_DIR/$REPORT_NAME" >> $GITHUB_OUTPUT
          fi
          
          echo "report_name=$REPORT_NAME" >> $GITHUB_OUTPUT
