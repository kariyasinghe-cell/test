    - name: Debug has_conflicts value
      ansible.builtin.debug:
        msg: "has_conflicts = {{ has_conflicts }}, dry_run_path = {{ dry_run_path }}"

    - name: Set conflicts.json path
      ansible.builtin.set_fact:
        conflicts_json_path: "{{ dry_run_path }}/updates/conflicts.json"
      when: has_conflicts | bool

    - name: Check if conflicts.json exists
      ansible.builtin.stat:
        path: "{{ conflicts_json_path }}"
      register: conflicts_json_stat
      when: has_conflicts | bool

    - name: Display conflicts.json check result
      ansible.builtin.debug:
        msg: "Conflicts.json exists: {{ conflicts_json_stat.stat.exists | default(false) }} at {{ conflicts_json_path }}"
      when: has_conflicts | bool

    - name: Read conflicts.json from remote server
      ansible.builtin.slurp:
        src: "{{ conflicts_json_path }}"
      register: conflicts_json_content
      when: 
        - has_conflicts | bool
        - conflicts_json_stat.stat.exists | default(false)

    - name: Parse conflicts.json
      ansible.builtin.set_fact:
        conflicts_data: "{{ conflicts_json_content.content | b64decode | from_json }}"
      when:
        - has_conflicts | bool
        - conflicts_json_content is defined
        - conflicts_json_content.content is defined

    - name: Display conflicts data
      ansible.builtin.debug:
        msg: "Found {{ conflicts_data | length }} conflict entries: {{ conflicts_data }}"
      when:
        - has_conflicts | bool
        - conflicts_data is defined

    - name: Fetch original file contents
      ansible.builtin.slurp:
        src: "{{ item.original }}"
      register: original_files
      loop: "{{ conflicts_data | default([]) }}"
      loop_control:
        label: "{{ item.original | basename }}"
      when:
        - has_conflicts | bool
        - conflicts_data is defined
        - conflicts_data | length > 0
      failed_when: false

    - name: Fetch new file contents
      ansible.builtin.slurp:
        src: "{{ item.new }}"
      register: new_files
      loop: "{{ conflicts_data | default([]) }}"
      loop_control:
        label: "{{ item.new | basename }}"
      when:
        - has_conflicts | bool
        - conflicts_data is defined
        - conflicts_data | length > 0
      failed_when: false

    - name: Build conflict comparisons data
      ansible.builtin.set_fact:
        conflict_comparisons: "{{ conflict_comparisons | default([]) + [comparison_item] }}"
      vars:
        comparison_item:
          filename: "{{ original_files.results[my_idx].item.original | regex_replace('.*dry-run/[^/]+/', '') | regex_replace('\\.original$', '') }}"
          original_path: "{{ original_files.results[my_idx].item.original }}"
          new_path: "{{ original_files.results[my_idx].item.new }}"
          original_content: "{{ original_files.results[my_idx].content | default('') | b64decode }}"
          new_content: "{{ new_files.results[my_idx].content | default('') | b64decode }}"
      loop: "{{ conflicts_data | default([]) }}"
      loop_control:
        index_var: my_idx
        label: "Building comparison {{ my_idx + 1 }}"
      when:
        - has_conflicts | bool
        - original_files is defined
        - original_files.results is defined
        - new_files is defined
        - new_files.results is defined
        - original_files.results | length > 0

    - name: Display conflict comparisons summary
      ansible.builtin.debug:
        msg: "Built {{ conflict_comparisons | default([]) | length }} conflict comparisons"
      when: has_conflicts | bool

    - name: Save conflict comparisons to JSON file
      ansible.builtin.copy:
        content: "{{ conflict_comparisons | default([]) | to_nice_json }}"
        dest: "/tmp/wso2_conflict_comparisons_{{ inventory_hostname }}.json"
        mode: '0644'
      delegate_to: localhost
      become: false
      when:
        - has_conflicts | bool
        - conflict_comparisons is defined
        - conflict_comparisons | length > 0
