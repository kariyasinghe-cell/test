# ==================== SAVE REPORT TO WSO2 SERVER ====================
    
    - name: Create reports directory on WSO2 server
      ansible.builtin.file:
        path: "/opt/wso2-reports"
        state: directory
        mode: '0755'
      when: has_conflicts | bool

    - name: Generate HTML report on localhost
      ansible.builtin.shell: |
        cat > /tmp/generate_diff_report.py << 'PYTHON_SCRIPT'
        #!/usr/bin/env python3
        import json
        import sys
        import difflib
        from datetime import datetime
        import html

        def create_diff_html(comparisons_file, output_file, environment, product, current_level, latest_level, dry_run_id):
            with open(comparisons_file, 'r') as f:
                comparisons = json.load(f)
            
            if not comparisons:
                print("No comparisons to process")
                return False
            
            report_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            html_content = f'''<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>WSO2 Update Conflict Report - {html.escape(environment)}</title>
            <style>
                * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }}
                .container {{ max-width: 1400px; margin: 0 auto; padding: 20px; }}
                .header {{ background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 40px; border-radius: 10px; margin-bottom: 30px; text-align: center; }}
                .header h1 {{ font-size: 2.2em; margin-bottom: 10px; }}
                .header p {{ opacity: 0.9; font-size: 1.1em; }}
                .info-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 30px 0; }}
                .info-card {{ background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                .info-card .label {{ font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }}
                .info-card .value {{ font-size: 1.3em; font-weight: 600; color: #1a1a2e; margin-top: 5px; }}
                .legend {{ background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                .legend h3 {{ margin-bottom: 15px; color: #1a1a2e; }}
                .legend-items {{ display: flex; gap: 30px; flex-wrap: wrap; }}
                .legend-item {{ display: flex; align-items: center; gap: 10px; }}
                .legend-color {{ width: 20px; height: 20px; border-radius: 4px; }}
                .legend-color.added {{ background: #d4edda; border: 1px solid #28a745; }}
                .legend-color.removed {{ background: #f8d7da; border: 1px solid #dc3545; }}
                .file-section {{ background: white; border-radius: 10px; margin-bottom: 30px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }}
                .file-header {{ background: #343a40; color: white; padding: 15px 20px; }}
                .file-header h2 {{ font-size: 1em; font-weight: 500; word-break: break-all; }}
                .file-number {{ background: #dc3545; padding: 3px 10px; border-radius: 12px; font-size: 0.85em; margin-right: 10px; }}
                .diff-container {{ overflow-x: auto; }}
                .diff-table {{ width: 100%; border-collapse: collapse; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 11px; }}
                .diff-table tr {{ border-bottom: 1px solid #eee; }}
                .diff-table td {{ padding: 1px 8px; white-space: pre-wrap; word-break: break-all; vertical-align: top; }}
                .diff-table .line-num {{ width: 40px; text-align: right; color: #999; background: #f8f9fa; border-right: 1px solid #dee2e6; user-select: none; }}
                .diff-table tr.added {{ background: #d4edda; }}
                .diff-table tr.added td {{ color: #155724; }}
                .diff-table tr.removed {{ background: #f8d7da; }}
                .diff-table tr.removed td {{ color: #721c24; }}
                .diff-table tr.header {{ background: #cce5ff; }}
                .diff-table tr.header td {{ color: #004085; font-weight: bold; }}
                .diff-table tr.range {{ background: #e2e3e5; }}
                .diff-table tr.range td {{ color: #383d41; }}
                .no-diff {{ padding: 30px; text-align: center; color: #6c757d; }}
                .truncated {{ padding: 10px; background: #fff3cd; color: #856404; text-align: center; }}
                .footer {{ text-align: center; padding: 30px; color: #6c757d; font-size: 0.9em; }}
                @media print {{ body {{ background: white; }} .file-section {{ break-inside: avoid; }} }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üö® WSO2 Update Conflict Report</h1>
                    <p>Manual resolution required for the following files</p>
                </div>
                
                <div class="info-grid">
                    <div class="info-card"><div class="label">Environment</div><div class="value">{html.escape(environment)}</div></div>
                    <div class="info-card"><div class="label">Product</div><div class="value">{html.escape(product)}</div></div>
                    <div class="info-card"><div class="label">Current Level</div><div class="value">v{html.escape(current_level)}</div></div>
                    <div class="info-card"><div class="label">Target Level</div><div class="value">v{html.escape(latest_level)}</div></div>
                    <div class="info-card"><div class="label">Conflicts</div><div class="value">{len(comparisons)} files</div></div>
                    <div class="info-card"><div class="label">Dry Run ID</div><div class="value">{html.escape(dry_run_id)}</div></div>
                    <div class="info-card"><div class="label">Generated</div><div class="value" style="font-size:1em">{report_time}</div></div>
                </div>
                
                <div class="legend">
                    <h3>Legend</h3>
                    <div class="legend-items">
                        <div class="legend-item"><div class="legend-color added"></div><span>Added in new version</span></div>
                        <div class="legend-item"><div class="legend-color removed"></div><span>Removed from your version</span></div>
                    </div>
                </div>
        '''
            
            for idx, comp in enumerate(comparisons, 1):
                filename = comp.get('filename', 'Unknown file')
                original_content = comp.get('original_content', '')
                new_content = comp.get('new_content', '')
                
                html_content += f'''
                <div class="file-section">
                    <div class="file-header">
                        <h2><span class="file-number">File {idx}</span>{html.escape(filename)}</h2>
                    </div>
                    <div class="diff-container">
        '''
                
                diff = list(difflib.unified_diff(
                    original_content.splitlines(keepends=True),
                    new_content.splitlines(keepends=True),
                    fromfile='Original (Your Version)',
                    tofile='New (Update Version)',
                    lineterm=''
                ))
                
                if not diff:
                    html_content += '<div class="no-diff">No differences found in this file.</div>'
                else:
                    html_content += '<table class="diff-table">'
                    max_lines = 1500
                    for i, line in enumerate(diff[:max_lines], 1):
                        line_escaped = html.escape(line.rstrip('\n\r'))
                        if line.startswith('+++') or line.startswith('---'):
                            cls = 'header'
                        elif line.startswith('@@'):
                            cls = 'range'
                        elif line.startswith('+'):
                            cls = 'added'
                        elif line.startswith('-'):
                            cls = 'removed'
                        else:
                            cls = ''
                        html_content += f'<tr class="{cls}"><td class="line-num">{i}</td><td>{line_escaped}</td></tr>'
                    
                    if len(diff) > max_lines:
                        html_content += f'</table><div class="truncated">‚ö†Ô∏è Truncated: {len(diff) - max_lines} more lines</div>'
                    else:
                        html_content += '</table>'
                
                html_content += '</div></div>'
            
            html_content += '''
                <div class="footer">
                    <p>Generated by WSO2 Update Check Workflow | Sampath Bank DevOps</p>
                </div>
            </div>
        </body>
        </html>
        '''
            
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(html_content)
            
            print(f"Report generated: {output_file}")
            return True

        if __name__ == "__main__":
            success = create_diff_html(
                sys.argv[1], sys.argv[2],
                sys.argv[3] if len(sys.argv) > 3 else "Unknown",
                sys.argv[4] if len(sys.argv) > 4 else "WSO2",
                sys.argv[5] if len(sys.argv) > 5 else "Unknown",
                sys.argv[6] if len(sys.argv) > 6 else "Unknown",
                sys.argv[7] if len(sys.argv) > 7 else "Unknown"
            )
            sys.exit(0 if success else 1)
        PYTHON_SCRIPT
        
        python3 /tmp/generate_diff_report.py \
          "/tmp/wso2_conflict_comparisons_{{ inventory_hostname }}.json" \
          "/tmp/wso2_conflict_report_{{ inventory_hostname }}.html" \
          "{{ lookup('env', 'ENVIRONMENT') | default('Unknown') }}" \
          "{{ wso2_product | default('wso2is') }} {{ wso2_version | default('5.11.0') }}" \
          "{{ current_update_level }}" \
          "{{ latest_available_level }}" \
          "{{ dry_run_id }}"
      delegate_to: localhost
      become: false
      when:
        - has_conflicts | bool
        - conflict_comparisons is defined
        - conflict_comparisons | length > 0
      register: html_report_generation

    - name: Copy HTML report to WSO2 server
      ansible.builtin.copy:
        src: "/tmp/wso2_conflict_report_{{ inventory_hostname }}.html"
        dest: "/opt/wso2-reports/conflict_report_{{ dry_run_id }}.html"
        mode: '0644'
      when:
        - has_conflicts | bool
        - html_report_generation is defined
        - html_report_generation.rc == 0

    - name: Set report URL fact
      ansible.builtin.set_fact:
        report_url: "http://{{ ansible_host }}:8090/conflict_report_{{ dry_run_id }}.html"
      when: has_conflicts | bool

    - name: Display report URL
      ansible.builtin.debug:
        msg: "Conflict report available at: {{ report_url }}"
      when: 
        - has_conflicts | bool
        - report_url is defined
